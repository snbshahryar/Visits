<!doctype html>
<html lang="fa" dir="rtl">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1">
<title>ÙØ±Ù… Ø«Ø¨Øª ÙˆÛŒØ²ÛŒØª Ù¾Ø²Ø´Ú© / Ø¯Ø§Ø±ÙˆØ®Ø§Ù†Ù‡</title>
<link href="https://cdn.jsdelivr.net/gh/rastikerdar/vazir-font@v30.1.0/dist/font-face.css" rel="stylesheet">
<style>
body{font-family:Vazir;background:#f4f6fb;margin:0;padding:20px;}
.container{max-width:800px;margin:auto;background:#fff;border-radius:10px;padding:20px;box-shadow:0 3px 10px rgba(0,0,0,0.1);}
h2{text-align:center;font-weight:700;margin-bottom:20px;}
label{display:block;margin-top:10px;}
input,select,textarea,button{width:100%;padding:10px;margin-top:5px;border:1px solid #ccc;border-radius:8px;font-family:Vazir;}
button{background-color:#2563eb;color:white;font-weight:600;cursor:pointer;margin-top:10px;border:none;border-radius:10px;padding:12px;}
button:hover{background-color:#1d4ed8;}
.row{display:flex;gap:10px;margin-top:15px;}
.row button{flex:1;}
.muted{text-align:center;color:#666;margin-top:10px;}
.warning{background:#fff3cd;color:#856404;padding:10px;border-radius:8px;margin-top:10px;display:none;}
.form-grid{display:grid;grid-template-columns:1fr;gap:15px;}
@media(min-width:768px){.form-grid{grid-template-columns:1fr 1fr;}}
textarea{grid-column:span 2;}
</style>
</head>
<body>

<div class="container">
<h2>ÙØ±Ù… Ø«Ø¨Øª ÙˆÛŒØ²ÛŒØª</h2>
<form id="visitForm">
  <div class="form-grid">
    <div>
      <label>Ù†Ø§Ù… Ù†Ù…Ø§ÛŒÙ†Ø¯Ù‡ Ø¹Ù„Ù…ÛŒ:</label>
      <select id="scientificRep" required>
        <option value="">Ø§Ù†ØªØ®Ø§Ø¨ Ú©Ù†ÛŒØ¯</option>
      </select>
    </div>
    <div>
      <label>Ù†Ø§Ù… Ù…Ø¯ÛŒØ± Ù…Ø³ØªÙ‚ÛŒÙ…:</label>
      <input type="text" id="directManager" readonly required>
    </div>
    <div>
      <label>Ù†Ø§Ù… Ù…Ø®Ø§Ø·Ø¨:</label>
      <input type="text" id="doctorName" required>
    </div>
    <div>
      <label>Ú©Ø¯ Ù†Ø¸Ø§Ù…:</label>
      <input type="text" id="license" required>
    </div>
    <div>
      <label>ØªØ®ØµØµ:</label>
      <select id="specialty" required>
        <option value="">Ø§Ù†ØªØ®Ø§Ø¨ Ú©Ù†ÛŒØ¯</option>
        <option value="Ù…Ø³Ø¦ÙˆÙ„ Ø®Ø±ÛŒØ¯">Ù…Ø³Ø¦ÙˆÙ„ Ø®Ø±ÛŒØ¯</option>
        <option value="Ù¾-Ù‚Ù„Ø¨">Ù¾-Ù‚Ù„Ø¨</option>
        <option value="Ù¾-Ø¯Ø§Ø®Ù„ÛŒ">Ù¾-Ø¯Ø§Ø®Ù„ÛŒ</option>
        <option value="Ù¾-Ù†ÙˆØ±ÙˆÙ„ÙˆÚ˜ÛŒ">Ù¾-Ù†ÙˆØ±ÙˆÙ„ÙˆÚ˜ÛŒ</option>
        <option value="Ù¾-Ù¾ÙˆØ³Øª">Ù¾-Ù¾ÙˆØ³Øª</option>
        <option value="Ø¯Ø§Ø±ÙˆØ³Ø§Ø²">Ø¯Ø§Ø±ÙˆØ³Ø§Ø²</option>
      </select>
    </div>
    <div>
      <label>Ù†ÙˆØ¹ ÙˆÛŒØ²ÛŒØª:</label>
      <select id="visitType" required>
        <option value="">Ø§Ù†ØªØ®Ø§Ø¨ Ú©Ù†ÛŒØ¯</option>
        <option value="ÙˆÛŒØ²ÛŒØª Ù¾Ø²Ø´Ú©">ÙˆÛŒØ²ÛŒØª Ù¾Ø²Ø´Ú©</option>
        <option value="ÙˆÛŒØ²ÛŒØª Ø¯Ø§Ø±ÙˆØ®Ø§Ù†Ù‡">ÙˆÛŒØ²ÛŒØª Ø¯Ø§Ø±ÙˆØ®Ø§Ù†Ù‡</option>
        <option value="ÙˆÙ‚ÙÙ‡ ÙˆÛŒØ²ÛŒØª">ÙˆÙ‚ÙÙ‡ ÙˆÛŒØ²ÛŒØª</option>
        <option value="ÙÙˆÙ‚ Ø¨Ø±Ù†Ø§Ù…Ù‡">ÙÙˆÙ‚ Ø¨Ø±Ù†Ø§Ù…Ù‡</option>
      </select>
    </div>
    <div style="grid-column: span 2;">
      <label>ØªÙˆØ¶ÛŒØ­Ø§Øª:</label>
      <textarea id="notes" rows="3"></textarea>
    </div>
  </div>

  <div class="row">
    <button type="button" id="startVisit">Ø´Ø±ÙˆØ¹ ÙˆÛŒØ²ÛŒØª</button>
    <button type="button" id="endVisit" disabled>Ù¾Ø§ÛŒØ§Ù† ÙˆÛŒØ²ÛŒØª</button>
  </div>

  <p id="locStatus" class="muted">Ø¯Ø± Ø­Ø§Ù„ Ø¨Ø±Ø±Ø³ÛŒ Ù…ÙˆÙ‚Ø¹ÛŒØª Ù…Ú©Ø§Ù†ÛŒ...</p>
  <div id="gpsWarning" class="warning">âš ï¸ Ù„Ø·ÙØ§Ù‹ GPS Ø¯Ø³ØªÚ¯Ø§Ù‡ Ø®ÙˆØ¯ Ø±Ø§ Ø±ÙˆØ´Ù† Ú©Ù†ÛŒØ¯.</div>

  <button type="submit" id="submitBtn" disabled>Ø«Ø¨Øª Ùˆ Ø§Ø±Ø³Ø§Ù„</button>
</form>
<p id="status" class="muted"></p>
</div>

<script>
const SCRIPT_URL = "https://script.google.com/macros/s/AKfycbzWc_b1B_u-hyx8vXIxvSo4DO7DeCZqyLWn4_SlbiQm7Csc42nmEySyniu5IOwey-K2gg/exec"; // ğŸ”¸ Ù„ÛŒÙ†Ú© ÙˆØ¨ Ø§Ù¾ Ø®ÙˆØ¯Øª

const managersData = {
  "ØªÛŒÙ… Ø­Ù…ÛŒØ¯Ø±Ø¶Ø§ ØªÙØªÛŒ": ["Ø§ÛŒØ±Ø¬ Ø¬ÙˆØ§Ù†Ù…Ø±Ø¯","ÙØ±Ø§Ù…Ø±Ø² Ø­Ø³ÛŒÙ† Ø²Ø§Ø¯Ù‡","Ø¹Ù„ÛŒ Ø¬Ø¹ÙØ±ÛŒ"],
  "ØªÛŒÙ… Ø³Ø¹ÛŒØ¯Ù‡ Ù…Ø­Ù…Ø¯ÛŒ": ["Ù†Ø¯Ø§ Ø­Ø§ØªÙ…ÛŒ","ÙØ§Ø·Ù…Ù‡ Ù…Ù‡Ø¯ÛŒ Ù†ÛŒØ§"],
  "ØªÛŒÙ… Ù…Ù‡Ø¯ÛŒ Ø®Ø§Ù†Ø¹Ù„ÛŒ Ù¾ÙˆØ±": ["Ù„ÛŒÙ„ÛŒ Ù†ØµÛŒØ±ÛŒ","Ø¢Ø±ÙˆÛŒÙ† Ø³ØªØ§ÛŒØ´"]
};

// Ù¾Ø± Ú©Ø±Ø¯Ù† Ù„ÛŒØ³Øª Ù†Ù…Ø§ÛŒÙ†Ø¯Ù‡â€ŒÙ‡Ø§
const repSelect = document.getElementById('scientificRep');
for (const [manager, reps] of Object.entries(managersData)) {
  reps.forEach(rep => {
    const opt = document.createElement('option');
    opt.value = rep;
    opt.textContent = rep;
    opt.dataset.manager = manager;
    repSelect.appendChild(opt);
  });
}
repSelect.addEventListener('change', e => {
  document.getElementById('directManager').value = e.target.selectedOptions[0].dataset.manager || '';
});

// GPS
let currentLocation = null;
function getLocation() {
  if (!navigator.geolocation) return;
  navigator.geolocation.getCurrentPosition(
    pos => {
      currentLocation = {
        latitude: pos.coords.latitude.toFixed(6),
        longitude: pos.coords.longitude.toFixed(6)
      };
      document.getElementById('locStatus').textContent = "âœ… Ù…ÙˆÙ‚Ø¹ÛŒØª Ø¯Ø±ÛŒØ§ÙØª Ø´Ø¯.";
    },
    err => {
      document.getElementById('locStatus').textContent = "âš ï¸ Ù„Ø·ÙØ§Ù‹ GPS Ø±Ø§ ÙØ¹Ø§Ù„ Ú©Ù†ÛŒØ¯.";
    }
  );
}
window.addEventListener('load', getLocation);

// Ø¯Ú©Ù…Ù‡â€ŒÙ‡Ø§
let timeIn = null, timeOut = null;
const startBtn = document.getElementById('startVisit');
const endBtn = document.getElementById('endVisit');
const submitBtn = document.getElementById('submitBtn');

startBtn.addEventListener('click',()=>{
  timeIn = new Date().toLocaleTimeString('fa-IR',{hour:'2-digit',minute:'2-digit'});
  startBtn.disabled = true;
  endBtn.disabled = false;
});
endBtn.addEventListener('click',()=>{
  timeOut = new Date().toLocaleTimeString('fa-IR',{hour:'2-digit',minute:'2-digit'});
  endBtn.disabled = true;
  submitBtn.disabled = false;
});

// Ø§Ø±Ø³Ø§Ù„ Ø¯Ø§Ø¯Ù‡
document.getElementById('visitForm').addEventListener('submit', async e=>{
  e.preventDefault();
  const data = {
    scientificRep: repSelect.value,
    directManager: document.getElementById('directManager').value,
    doctorName: document.getElementById('doctorName').value,
    license: document.getElementById('license').value,
    specialty: document.getElementById('specialty').value,
    visitType: document.getElementById('visitType').value,
    notes: document.getElementById('notes').value,
    latitude: currentLocation?.latitude || '',
    longitude: currentLocation?.longitude || '',
    timeIn, timeOut
  };
  try {
    const res = await fetch(SCRIPT_URL, {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify(data)
    });
    const result = await res.json();
    document.getElementById('status').textContent = "âœ… Ø«Ø¨Øª Ø´Ø¯: " + result.serverTimestamp;
    e.target.reset();
    startBtn.disabled = false;
    endBtn.disabled = true;
    submitBtn.disabled = true;
  } catch(err) {
    document.getElementById('status').textContent = "âŒ Ø®Ø·Ø§ Ø¯Ø± Ø§Ø±Ø³Ø§Ù„: " + err.message;
  }
});
</script>
</body>
</html>
